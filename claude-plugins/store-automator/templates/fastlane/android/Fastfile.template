default_platform(:android)

# Resolve paths absolutely to avoid symlink-relative breakage.
# PROJECT_ROOT is set by CI scripts (read-config.sh); locally we derive from __FILE__.
ROOT_DIR = ENV.fetch("PROJECT_ROOT", File.expand_path("../..", __FILE__))
APP_DIR  = ENV.fetch("APP_ROOT", "#{ROOT_DIR}/app")
APP_DIR  = "#{ROOT_DIR}/#{APP_DIR}" unless APP_DIR.start_with?("/")

AAB_PATH = "#{APP_DIR}/build/app/outputs/bundle/release/app-release.aab"
METADATA_DIR  = "#{ROOT_DIR}/fastlane/metadata/android"
SCREENSHOT_DIR = "#{ROOT_DIR}/fastlane/screenshots/android"

# Fastlane supply expects screenshots at {metadata_path}/{locale}/images/.
# Our screenshots live in a separate directory (fastlane/screenshots/android/{locale}/).
# Bridge the gap by symlinking each locale's screenshot folder into the metadata tree.
def link_screenshots_into_metadata
  return unless File.directory?(SCREENSHOT_DIR)
  Dir.glob("#{SCREENSHOT_DIR}/*/").each do |locale_dir|
    locale = File.basename(locale_dir)
    images_link = "#{METADATA_DIR}/#{locale}/images"
    next if File.exist?(images_link)
    FileUtils.mkdir_p("#{METADATA_DIR}/#{locale}")
    FileUtils.ln_s(locale_dir.chomp("/"), images_link)
    Fastlane::UI.message("Linked screenshots: #{images_link} -> #{locale_dir.chomp('/')}")
  end
end

def metadata_changed?(path)
  !sh("git diff --name-only HEAD~1 -- #{path}").strip.empty?
rescue StandardError
  true
end

# Shared upload options reused across Android lanes.
def base_play_store_options
  {
    package_name: ENV["PACKAGE_NAME"],
    track: ENV.fetch("TRACK", "internal"),
    json_key: ENV["GOOGLE_PLAY_SERVICE_ACCOUNT_JSON_PATH"]
  }
end

def rollout_options
  {
    rollout: ENV.fetch("ROLLOUT_FRACTION", "").empty? ? nil : ENV["ROLLOUT_FRACTION"].to_f,
    in_app_update_priority: ENV.fetch("IN_APP_UPDATE_PRIORITY", "3").to_i
  }
end

platform :android do
  lane :deploy_android do
    link_screenshots_into_metadata
    status = ENV.fetch("RELEASE_STATUS", "draft")
    opts = base_play_store_options.merge(
      aab: AAB_PATH,
      release_status: status,
      skip_upload_metadata: !metadata_changed?("fastlane/metadata/android/"),
      skip_upload_screenshots: !metadata_changed?("fastlane/screenshots/android/"),
      skip_upload_images: !metadata_changed?("fastlane/screenshots/android/"),
      skip_upload_changelogs: false,
      metadata_path: METADATA_DIR
    )
    opts.merge!(rollout_options) unless status == "draft"
    upload_to_play_store(opts)
  end

  lane :upload_metadata_android do
    # supply always calls fetch_track_and_release! even for metadata-only
    # uploads.  When the track contains multiple releases and no version_code
    # is given it errors with "more than one release found".  We resolve this
    # by fetching the latest version code from the track first.
    track = ENV.fetch("TRACK", "internal")
    codes = google_play_track_version_codes(
      package_name: ENV["PACKAGE_NAME"],
      json_key: ENV["GOOGLE_PLAY_SERVICE_ACCOUNT_JSON_PATH"],
      track: track
    )
    latest_code = codes.max

    # Draft apps only accept draft releases.  Use RELEASE_STATUS env var so
    # this keeps working after the first production release.
    status = ENV.fetch("RELEASE_STATUS", "draft")

    link_screenshots_into_metadata
    upload_to_play_store(
      base_play_store_options.merge(
        version_code: latest_code,
        release_status: status,
        skip_upload_aab: true,
        skip_upload_apk: true,
        skip_upload_metadata: false,
        skip_upload_screenshots: false,
        skip_upload_images: false,
        skip_upload_changelogs: true,
        metadata_path: METADATA_DIR
      )
    )
  end

  lane :upload_binary_android do
    status = ENV.fetch("RELEASE_STATUS", "draft")
    opts = base_play_store_options.merge(
      aab: AAB_PATH,
      release_status: status,
      skip_upload_metadata: true,
      skip_upload_screenshots: true,
      skip_upload_images: true,
      skip_upload_changelogs: true
    )
    # Rollout percentage is only valid for non-draft releases
    opts.merge!(rollout_options) unless status == "draft"
    upload_to_play_store(opts)
  end

  lane :sync_google_iap do
    manage_google_iap(
      json_key: ENV["GOOGLE_PLAY_SERVICE_ACCOUNT_JSON_PATH"],
      package_name: ENV["PACKAGE_NAME"],
      config_path: "#{ROOT_DIR}/fastlane/iap_config.json"
    )
  end

  lane :update_data_safety do
    script = "#{ROOT_DIR}/scripts/update_data_safety.py"
    csv = "#{ROOT_DIR}/fastlane/data_safety.csv"
    sh("python3", script, csv) if File.exist?(csv)
  end
end
