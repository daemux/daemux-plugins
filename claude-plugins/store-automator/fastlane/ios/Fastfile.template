default_platform(:ios)

# Resolve paths absolutely to avoid symlink-relative breakage.
# PROJECT_ROOT is set by CI scripts (read-config.sh); locally we derive from __FILE__.
ROOT_DIR = ENV.fetch("PROJECT_ROOT", File.expand_path("../..", __FILE__))
APP_ROOT = ENV.fetch("APP_ROOT", "app")

def metadata_changed?(path)
  !sh("git diff --name-only HEAD~1 -- #{path}").strip.empty?
rescue StandardError
  true
end

def asc_api_key
  key_path = ENV["FASTLANE_API_KEY_PATH"]
  if key_path && File.exist?(key_path)
    app_store_connect_api_key(
      key_id: ENV["APP_STORE_CONNECT_KEY_IDENTIFIER"],
      issuer_id: ENV["APP_STORE_CONNECT_ISSUER_ID"],
      key_filepath: key_path,
      is_key_content_base64: false
    )
  else
    app_store_connect_api_key(
      key_id: ENV["APP_STORE_CONNECT_KEY_IDENTIFIER"],
      issuer_id: ENV["APP_STORE_CONNECT_ISSUER_ID"],
      key_content: ENV["APP_STORE_CONNECT_PRIVATE_KEY"],
      is_key_content_base64: false
    )
  end
end

# Shared deliver options reused across iOS lanes.
def base_deliver_options
  {
    api_key: asc_api_key,
    app_identifier: ENV["BUNDLE_ID"],
    force: true
  }
end

def metadata_deliver_options
  base_deliver_options.merge(
    metadata_path: "#{ROOT_DIR}/fastlane/metadata",
    screenshots_path: "#{ROOT_DIR}/fastlane/screenshots/ios",
    sync_screenshots: true,
    app_rating_config_path: "#{ROOT_DIR}/fastlane/app_rating_config.json",
    price_tier: ENV.fetch("PRICE_TIER", "0").to_i,
    primary_category: ENV.fetch("PRIMARY_CATEGORY", "UTILITIES"),
    secondary_category: ENV.fetch("SECONDARY_CATEGORY", "PRODUCTIVITY")
  )
end

def submission_options
  {
    submit_for_review: ENV.fetch("SUBMIT_FOR_REVIEW", "true") == "true",
    automatic_release: ENV.fetch("AUTOMATIC_RELEASE", "true") == "true"
  }
end

platform :ios do
  lane :deploy_ios do
    deliver(
      metadata_deliver_options.merge(submission_options).merge(
        ipa: Dir.glob("#{ROOT_DIR}/#{APP_ROOT}/build/ios/ipa/*.ipa").first,
        skip_metadata: !metadata_changed?("fastlane/metadata/ios/"),
        skip_screenshots: !metadata_changed?("fastlane/screenshots/ios/"),
        run_precheck_before_submit: true,
        precheck_include_in_app_purchases: false
      )
    )
  end

  lane :upload_metadata_ios do
    deliver(
      metadata_deliver_options.merge(
        skip_binary_upload: true,
        skip_metadata: false,
        skip_screenshots: false,
        run_precheck_before_submit: false,
        submit_for_review: false
      )
    )
  end

  lane :upload_binary_ios do
    deliver(
      base_deliver_options.merge(submission_options).merge(
        ipa: Dir.glob("#{ROOT_DIR}/#{APP_ROOT}/build/ios/ipa/*.ipa").first,
        skip_metadata: true,
        skip_screenshots: true,
        run_precheck_before_submit: true,
        precheck_include_in_app_purchases: false
      )
    )
  end

  lane :sync_iap do
    manage_iap(
      api_key: asc_api_key,
      app_id: ENV["BUNDLE_ID"],
      config_path: "#{ROOT_DIR}/fastlane/iap_config.json"
    )
  end
end
