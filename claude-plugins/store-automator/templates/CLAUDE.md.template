# {APP_NAME} - Development Standards

## Project Overview

This is a Flutter app with Firebase backend, automated for App Store and Google Play publishing via GitHub Actions CI/CD. This repository MUST be PRIVATE as it contains credential files.

## Mandatory Rules

### Agent Delegation (NEVER violate)
- ALWAYS delegate ALL tasks to agents - use either plugin agents or built-in agents (via Task tool)
- NEVER perform any work directly - the main agent's role is ONLY to coordinate and delegate
- This includes verification: if you need to confirm an agent's claims, delegate verification to another agent (e.g., tester) — do NOT run commands yourself
- This applies to ALL task types: coding, research, exploration, file operations, testing, deployment, and any other work
- If unsure which agent to use, use the Task tool with a general-purpose, explore or any other built-in agent

### DevOps Agent Required
ALL deployment and infrastructure operations SHOULD use the devops agent (deploy, firebase, cloudflare, database/deploy, database/optimize).
Prefer using the devops agent over direct Bash/SSH for structured operations.

### Code Quality (enforced by agents)
- No TODO/FIXME in committed code
- No Mock/placeholder code
- No hardcoded secrets
- Use appropriate data types for precision requirements
- Sanitize and validate all external inputs
- Follow language-specific security best practices

## Code Limits (MANDATORY)

| Limit | Value | Action if Exceeded |
|-------|-------|-------------------|
| File size | 400 lines | Split into modules |
| Functions per file | 10 | Group by domain/feature |
| Function length | 50 lines | Extract helper functions |
| Line width | 120 chars | Wrap or refactor |
| Max nesting | 5 levels | Use early returns |

## Configuration Files

### ci.config.yaml
Single source of truth: credentials, app identity, store settings, web domain.

### fastlane/metadata/ Structure
All store listing texts are stored in fastlane directories and managed by the appstore-meta-creator agent:

**iOS** (fastlane/metadata/ios/{locale}/):
name.txt, subtitle.txt, description.txt, keywords.txt, promotional_text.txt, release_notes.txt, privacy_url.txt, support_url.txt, marketing_url.txt

**Android** (fastlane/metadata/android/{locale}/):
title.txt, short_description.txt, full_description.txt, changelogs/default.txt

### fastlane/data_safety.csv
Google Play Data Safety declarations in `question_id,response` CSV format. Declares what data the app collects, shares, its purpose, and security practices. Generated by the appstore-meta-creator agent and uploaded via `scripts/update_data_safety.py`. See `templates/fastlane/data_safety.csv.example` for format reference.

### fastlane/iap_config.json
IAP and subscription configuration. Durations: ONE_WEEK to ONE_YEAR. Intro offers: FREE, PAY_AS_YOU_GO, PAY_UP_FRONT.

### fastlane/screenshots/
Store screenshots by platform and device size. Generated by app-designer via Stitch MCP.

## Flutter Project Structure

### Folder Structure
```
lib/
  app/
    app.dart              # MaterialApp setup
    router.dart           # GoRouter configuration
    theme.dart            # ThemeData
  core/
    constants/
    extensions/
    utils/
    widgets/              # Shared widgets
  features/
    {feature}/
      models/             # Data classes, entities
      providers/          # Riverpod providers (or cubits/)
      repositories/       # Data sources, API calls
      screens/            # Full-page widgets
      widgets/            # Feature-specific widgets
  services/
    firebase/
    api/
```

### Recommended Stack
- **Riverpod** (recommended): flutter_riverpod + riverpod_annotation + riverpod_generator, go_router, dio, freezed + json_serializable, Firebase suite, in_app_purchase (use RevenueCat/Adapty if TASK.md specifies)
- **BLoC** (alternative): flutter_bloc, go_router, get_it + injectable, dio, freezed + json_serializable, Firebase suite, in_app_purchase (use RevenueCat/Adapty if TASK.md specifies)

## Workflow

### Task Type Detection

Detect from user request:
- **flutter** - App UI, widgets, screens, Dart code, state management
- **backend** - Firebase Cloud Functions, Firestore rules, server-side logic
- **design** - App design, store screenshots, web page design (Stitch MCP)
- **metadata** - Store listing texts, IAP config, app rating
- **database** - Firestore schema, indexes, data migration
- **infra** - GitHub Actions CI/CD, Firebase deploy, Cloudflare web deploy
- **standard** - Mixed or unclear scope

### Agent Flows

#### Standard Flow
```
architect → product-manager(PRE) → developer → simplifier → reviewer → tester → product-manager(POST) → [devops]
```

#### Flutter Flow
```
architect → product-manager(PRE) → [app-designer] → developer(flutter) → simplifier → reviewer → tester(flutter) → tester(mobile-ui) → product-manager(POST) → [devops(deploy)]
```

#### Backend Flow
```
architect → product-manager(PRE) → developer(backend) → simplifier → reviewer → tester(backend) → product-manager(POST) → [devops(deploy)]
```

#### Design Flow
```
app-designer → appstore-reviewer
```

#### Metadata Flow
```
appstore-meta-creator → appstore-reviewer
```

#### Database Flow
```
architect → developer(backend) → simplifier → reviewer → product-manager(POST) → [devops(deploy)]
```

#### Infra Flow
```
devops (standalone)
```

#### Full Publishing Flow (Design to App Store)
```
architect → product-manager(PRE) → app-designer → developer(flutter) → simplifier → reviewer → tester(flutter) → tester(mobile-ui) → appstore-meta-creator → appstore-reviewer → product-manager(POST) → devops(deploy)
```

#### Team Size Annotations

Flows above use single agents by default. For tasks touching 3+ files, apply team sizes:

| Files Touched | Team Size |
|--------------|-----------|
| 1-2 files | Single agent (no team) |
| 3-4 files | 2 teammates |
| 5-7 files | 3 teammates |
| 8+ files | 4 teammates |

**Team-annotated flows** (apply when task scope exceeds 2 files):

##### Standard Flow (with teams)
```
architect{T:2} → product-manager(PRE) → developer{T:2-4} → simplifier → reviewer{T:2} → tester{T:2} → product-manager(POST) → [devops]
```

##### Flutter Flow (with teams)
```
architect{T:2} → product-manager(PRE) → [app-designer{T:2-3}] → developer(flutter){T:2-4} → simplifier → reviewer{T:2-3} → tester(flutter){T:2} → tester(mobile-ui){T:2} → product-manager(POST) → [devops(deploy)]
```

##### Backend Flow (with teams)
```
architect{T:2} → product-manager(PRE) → developer(backend){T:2-4} → simplifier → reviewer{T:2} → tester(backend){T:2} → product-manager(POST) → [devops(deploy)]
```

##### Full Publishing Flow (with teams)
```
architect{T:2} → product-manager(PRE) → app-designer{T:2-3} → developer(flutter){T:2-4} → simplifier → reviewer{T:2-3} → tester(flutter){T:2} → tester(mobile-ui){T:2} → appstore-meta-creator{T:2-5} → appstore-reviewer → product-manager(POST) → devops(deploy)
```

### Agents Reference

| Agent | When to use |
|-------|-------------|
| architect | BEFORE developer - designs Flutter architecture |
| product-manager | PRE-DEV: validates approach. POST-DEV: after tests pass |
| developer | Code implementation (type: flutter/backend/fullstack) |
| simplifier | AFTER developer - simplifies Dart/Flutter code |
| reviewer | After ANY code changes - Dart/Flutter quality review |
| tester | After review passes (type: flutter/mobile-ui/web/backend/integration) |
| devops | Operations (mode: deploy/firebase/cloudflare/database+deploy/database+optimize) |
| app-designer | Stitch MCP design: app screens + store screenshots + web page design |
| appstore-meta-creator | Generate store listing texts for all configured languages |
| appstore-reviewer | Full App Store/Play compliance review including live app UI testing via mobile-mcp |
| Explore (Task tool) | Read/understand code |

### Optional Agents

| Agent | When to Skip |
|-------|--------------|
| [devops] | No deployment configured (workflow ends at product-manager(POST)) |
| [app-designer] | App designs already exist or minor code changes |
| [appstore-meta-creator] | Metadata already exists and unchanged |
| [appstore-reviewer] | No store submission in this iteration |

### Autonomous Iteration Philosophy

**Self-Correction (MANDATORY):** Before each fix attempt:
1. Read previous error output carefully
2. Check git diff to see what was already tried
3. Identify WHY it failed, not just WHAT failed
4. Try a DIFFERENT approach if same fix failed twice

**Persistence Wins:** Keep iterating until success.

### Fix-and-Verify Loops

**review-loop:** reviewer → PASS? → EXIT | ISSUES? → developer → reviewer (repeat)

**manager-loop:** product-manager → COMPLETE? → EXIT | ISSUES? → developer → product-manager (repeat)

**test-loop:** tester → PASS? → EXIT | FAIL? → developer → simplifier → reviewer → tester (repeat)

If the same error persists unchanged after one full fix cycle, try a fundamentally different approach. If an agent crashes or returns empty output, re-run it once. If a test passes on re-run without code changes, note it as flaky and proceed.

### Gates & Prerequisites

**Before product-manager (POST-DEV):**
- `TESTS: PASSED` from tester
- `Review: NO ISSUES` from reviewer

**Before devops:**
- `APPROVED` or `COMPLETE` from product-manager
- Deployment is optional when not configured

**Before devops(deploy):**
- appstore-reviewer APPROVED (if publishing)
- All metadata files present for configured languages
- All screenshots present and verified (dimensions match requirements)

Missing evidence means run that agent first. Do NOT proceed without it.

**Verification rule:** Trust agent output at face value. If an agent reports PASS/COMPLETE, proceed to the next stage. Do NOT independently re-run tests or checks — that is the agent's job, not yours. If you doubt an agent's output, re-run that agent (not the commands yourself).

### Parallel Execution

**Launch multiple agents in ONE message when possible.**

**Parallel OK:** Independent features, backend + frontend, tester(flutter) + tester(mobile-ui), appstore-meta-creator + app-designer (if designs ready)

**Sequential ONLY:** Same-file changes, simplifier → reviewer, review-fix cycles, deployer after tests

## Workflow: Design to Publish

### Phase 1: App Design + Store Screenshots
app-designer creates all screens and screenshots in Stitch MCP. Complete design before code. Save to fastlane/screenshots/.

### Phase 2: Develop
Implement Flutter app matching designs. Set up Firebase. Fill ci.config.yaml. Add credential files.

### Phase 3: Store Metadata + Texts
appstore-meta-creator generates texts. Fill fastlane/iap_config.json if needed.

### Phase 4: Web Pages + Deployment
app-designer designs marketing page in Stitch MCP. Develop web pages. Deploy via Cloudflare Pages (*.account-subdomain.workers.dev domain sufficient).

### Phase 5: Finalize and CI/CD
Create .gitignore (.claude/.tasks/, Flutter ignores; do NOT ignore *.g.dart). Push to private repo. GitHub Actions auto-triggers on push.

### Phase 6: First Publish
iOS: fully automated. Android: first build creates AAB + manual steps guide; subsequent builds fully automated.

### Phase 7: Ongoing Updates
Push to main. GitHub Actions detects changes and uploads modified assets. Version auto-incremented.

---
## FOR ORCHESTRATORS ONLY
**If you are a TEAMMATE, skip to "For Teammates" section below.**
---

### Agent Teams (MANDATORY by default)

**Teams are the DEFAULT for most workflow stages.** Single-agent is the exception, not the norm.

#### Mandatory Team Stages

These stages MUST use teams unless the task touches fewer than 3 files:

| Stage | Default Size | Split Strategy |
|-------|-------------|----------------|
| architect | 2 | Split by concern: structure/patterns vs integration/data-flow |
| developer | 2-4 | Split by file group: screens/widgets vs providers/repos vs Firebase/backend |
| reviewer | 2-3 | Split by focus: Dart quality vs security+Firebase rules vs performance+store compliance |
| tester | 2-4 | Split by type: flutter unit/widget vs mobile-ui iOS vs mobile-ui Android vs web |
| app-designer | 2-3 | Split by deliverable: app screens vs store screenshots vs web page |
| appstore-meta-creator | 2-5 | Split by language group: each teammate handles 2-5 languages grouped by similarity |

#### Single-Agent Stages (exceptions)

These stages stay single-agent — teams add no value:

| Stage | Reason |
|-------|--------|
| simplifier | Works on same files developer just touched — no parallelism possible |
| product-manager | Single evaluation checkpoint — multiple perspectives don't help |
| devops | Single deployment target — cannot parallelize |
| appstore-reviewer | Single compliance evaluation — one holistic review needed |

#### Team Size Triggers

| Files Touched | Team Size |
|--------------|-----------|
| 1-2 files | Single agent — TEAM EXCEPTION |
| 3-4 files | 2 teammates |
| 5-7 files | 3 teammates |
| 8+ files | 4 teammates |

**Team Enforcement (MANDATORY):**
If `TEAMS:` output includes any stage using teams, you MUST call `TeamCreate` before spawning agents for that stage. Spawning agents via `Task` without `team_name` does NOT count as using teams. Violation = workflow non-compliance.

**When creating a team:**

```
Create agent team with [N] teammates, all using Opus model:
- [role-1]: [Specific responsibility and task details]
- [role-2]: [Specific responsibility and task details]
- [role-3]: [Specific responsibility and task details]
...

Spawn each teammate with detailed prompt including:
- Their specific role and responsibilities
- The task details
- How to coordinate with other teammates
```

**Guidelines:**
- Use 2-10 teammates per stage
- Always specify Opus model for all teammates
- Assign distinct, non-overlapping scopes to each teammate
- Include full instructions in spawn prompts (don't reference external files)
- One team at a time - dissolve before next stage
- Assign 5-6 tasks per teammate

---
## FOR TEAMMATES ONLY
**If you are the ORCHESTRATOR, skip this section.**
---

### Teammate Instructions

**Ignore orchestration workflows above.**

1. Your spawn prompt contains your full instructions
2. Message teammates directly to coordinate
3. Focus only on your assigned scope
4. Complete your work, let team dissolve

---

### Large Task Protocol

For tasks with 5+ requirements:

1. **Save requirements** to `.claude/.tasks/{short-topic}.md` before starting any agent (create `.claude/.tasks/` directory if it doesn't exist)
2. **Each session:** pass the exact file path (e.g., `.claude/.tasks/auth-system.md`) to architect and product-manager
3. **After each batch:** `/clear` and continue — tell user which task file to reference
4. **Done when:** product-manager confirms zero remaining and deletes the task file

Rules:
- ALWAYS pass the exact `.claude/.tasks/` file path when calling architect and product-manager agents
- Architect and product-manager will read ONLY the specified file — never guess the filename
- Add `.claude/.tasks/` to `.gitignore`

### Output Format and Continuation

**CRITICAL: Copy the EXACT flow from the Agent Flows section above. Include ALL agents, including optional ones in `[brackets]`. Do NOT abbreviate or skip agents.**

Output the analysis in this format:

```
TASK TYPE: [flutter/backend/design/metadata/database/infra/standard]

RECOMMENDED FLOW:
<copy the EXACT flow from Agent Flows section - include ALL agents with [optional] ones>

TEAMS: [MANDATORY — list team stages with sizes. Single-agent exceptions: list which stages and why. "NO" only valid for tasks <3 files]

DEPLOYMENT: [AVAILABLE - deployment configured | NOT CONFIGURED - workflow ends at product-manager(POST)]

TASK TRACKING: ALWAYS use TaskCreate/TaskUpdate/TaskList tools for multi-step tasks (3+ steps)

NOTES:
- [any special considerations]

LAUNCHING: [first-agent-name]
```

**Expected RECOMMENDED FLOW outputs (copy exactly):**

- **flutter**: `architect → product-manager(PRE) → [app-designer] → developer(flutter) → simplifier → reviewer → tester(flutter) → tester(mobile-ui) → product-manager(POST) → [devops(deploy)]`
- **backend**: `architect → product-manager(PRE) → developer(backend) → simplifier → reviewer → tester(backend) → product-manager(POST) → [devops(deploy)]`
- **design**: `app-designer → appstore-reviewer`
- **metadata**: `appstore-meta-creator → appstore-reviewer`
- **database**: `architect → developer(backend) → simplifier → reviewer → product-manager(POST) → [devops(deploy)]`
- **infra**: `devops (standalone)`
- **standard**: `architect → product-manager(PRE) → developer → simplifier → reviewer → tester → product-manager(POST) → [devops]`

**MANDATORY: After outputting the workflow analysis above, you MUST:**
1. **Create tasks** using TaskCreate for each major step in the workflow (if 3+ steps)
2. **Immediately invoke** the first agent using the Task tool in the same response

Do NOT stop. Do NOT wait for user confirmation. The workflow skill is not complete until tasks are created and the first agent is launched.
