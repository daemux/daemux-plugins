default_platform(:ios)

# Resolve paths absolutely to avoid symlink-relative breakage.
# PROJECT_ROOT is set by CI scripts (read-config.sh); locally we derive from __FILE__.
ROOT_DIR = ENV.fetch("PROJECT_ROOT", File.expand_path("../..", __FILE__))
APP_DIR  = ENV.fetch("APP_ROOT", "#{ROOT_DIR}/app")
APP_DIR  = "#{ROOT_DIR}/#{APP_DIR}" unless APP_DIR.start_with?("/")

# Monkey-patch: Fastlane deliver crashes with "No data" when fetching
# app_store_review_detail on the first version (fastlane/fastlane#20538).
# Wrap the method to rescue the RuntimeError gracefully.
# Require deliver explicitly so the constant is available at parse time.
require "deliver"
::Deliver::UploadMetadata.prepend(Module.new do
  def review_attachment_file(version)
    super
  rescue RuntimeError => e
    raise unless e.message.include?("No data")
    Fastlane::UI.important("Skipping review attachment: #{e.message} (first version)")
  end
end)

def metadata_changed?(path)
  !sh("git diff --name-only HEAD~1 -- #{path}").strip.empty?
rescue StandardError
  true
end

def asc_api_key
  params = {
    key_id: ENV["APP_STORE_CONNECT_KEY_IDENTIFIER"],
    issuer_id: ENV["APP_STORE_CONNECT_ISSUER_ID"],
    is_key_content_base64: false
  }
  key_path = ENV["FASTLANE_API_KEY_PATH"]
  if key_path && File.exist?(key_path)
    params[:key_filepath] = key_path
  else
    params[:key_content] = ENV["APP_STORE_CONNECT_PRIVATE_KEY"]
  end
  app_store_connect_api_key(params)
end

# Shared deliver options reused across iOS lanes.
def base_deliver_options
  {
    api_key: asc_api_key,
    app_identifier: ENV["BUNDLE_ID"],
    force: true
  }
end

def metadata_deliver_options
  base_deliver_options.merge(
    metadata_path: "#{ROOT_DIR}/fastlane/metadata",
    screenshots_path: "#{ROOT_DIR}/fastlane/screenshots/ios",
    sync_screenshots: true,
    primary_category: ENV.fetch("PRIMARY_CATEGORY", "UTILITIES"),
    secondary_category: ENV.fetch("SECONDARY_CATEGORY", "PRODUCTIVITY"),
    app_rating_config_path: "#{ROOT_DIR}/fastlane/app_rating_config.json"
  )
end

def submission_options
  {
    submit_for_review: ENV.fetch("SUBMIT_FOR_REVIEW", "true") == "true",
    automatic_release: ENV.fetch("AUTOMATIC_RELEASE", "true") == "true"
  }
end

platform :ios do
  lane :deploy_ios do
    deliver(
      metadata_deliver_options.merge(submission_options).merge(
        ipa: Dir.glob("#{APP_DIR}/build/ios/ipa/*.ipa").first,
        skip_metadata: !metadata_changed?("fastlane/metadata/ios/"),
        skip_screenshots: !metadata_changed?("fastlane/screenshots/ios/"),
        run_precheck_before_submit: true,
        precheck_include_in_app_purchases: false,
        submission_information: {
          export_compliance_uses_encryption: false,
          content_rights_contains_third_party_content: false,
          content_rights_has_rights: true
        }
      )
    )
  end

  lane :upload_metadata_ios do
    deliver(
      metadata_deliver_options.merge(
        skip_binary_upload: true,
        skip_metadata: false,
        skip_screenshots: false,
        overwrite_screenshots: true,
        run_precheck_before_submit: false,
        submit_for_review: false
      )
    )
  end

  lane :upload_binary_ios do
    deliver(
      base_deliver_options.merge(
        ipa: Dir.glob("#{APP_DIR}/build/ios/ipa/*.ipa").first,
        skip_metadata: true,
        skip_screenshots: true,
        run_precheck_before_submit: false,
        submit_for_review: false
      )
    )
  end

  lane :sync_iap do
    config_path = "#{ROOT_DIR}/fastlane/iap_config.json"
    script = "#{ROOT_DIR}/scripts/sync_iap_ios.py"
    sh("python3", script, config_path) if File.exist?(config_path) && File.exist?(script)
  end

  lane :upload_privacy_ios do
    # Note: upload_app_privacy_details_to_app_store requires Apple ID authentication
    # (username + team_name), not API key. Use APPLE_ID and APPLE_TEAM_NAME env vars.
    upload_app_privacy_details_to_app_store(
      username: ENV.fetch("APPLE_ID", ""),
      team_name: ENV.fetch("APPLE_TEAM_NAME", ""),
      app_identifier: ENV["BUNDLE_ID"],
      json_path: "#{ROOT_DIR}/fastlane/app_privacy_details.json"
    )
  end

  # NOTE: produce requires Apple ID auth (not API key). Run locally for new apps.
  lane :create_app_ios do
    produce(
      username: ENV.fetch("APPLE_ID", ""),
      team_name: ENV.fetch("APPLE_TEAM_NAME", ""),
      app_identifier: ENV["BUNDLE_ID"],
      app_name: ENV.fetch("APP_NAME", ""),
      sku: ENV.fetch("SKU", ENV["BUNDLE_ID"]),
      language: ENV.fetch("PRIMARY_LOCALE", "en-US"),
      enable_services: {}
    )
  end
end
