default_platform(:ios)

# Resolve paths absolutely to avoid symlink-relative breakage.
# CM_BUILD_DIR is set by Codemagic CI; locally we derive from __FILE__.
ROOT_DIR = ENV.fetch("CM_BUILD_DIR", File.expand_path("../..", __FILE__))
APP_DIR  = ENV.fetch("APP_ROOT", "#{ROOT_DIR}/app")
APP_DIR  = "#{ROOT_DIR}/#{APP_DIR}" unless APP_DIR.start_with?("/")

# Monkey-patch: Fastlane deliver crashes with "No data" when fetching
# app_store_review_detail on the first version (fastlane/fastlane#20538).
# Wrap the method to rescue the RuntimeError gracefully.
# Require deliver explicitly so the constant is available at parse time.
require "deliver"
::Deliver::UploadMetadata.prepend(Module.new do
  def review_attachment_file(version)
    super
  rescue RuntimeError => e
    raise unless e.message.include?("No data")
    Fastlane::UI.important("Skipping review attachment: #{e.message} (first version)")
  end
end)

def metadata_changed?(path)
  !sh("git diff --name-only HEAD~1 -- #{path}").strip.empty?
rescue StandardError
  true
end

def asc_api_key
  key_path = ENV["FASTLANE_API_KEY_PATH"]
  if key_path && File.exist?(key_path)
    app_store_connect_api_key(
      key_id: ENV["APP_STORE_CONNECT_KEY_IDENTIFIER"],
      issuer_id: ENV["APP_STORE_CONNECT_ISSUER_ID"],
      key_filepath: key_path,
      is_key_content_base64: false
    )
  else
    app_store_connect_api_key(
      key_id: ENV["APP_STORE_CONNECT_KEY_IDENTIFIER"],
      issuer_id: ENV["APP_STORE_CONNECT_ISSUER_ID"],
      key_content: ENV["APP_STORE_CONNECT_PRIVATE_KEY"],
      is_key_content_base64: false
    )
  end
end

# Shared deliver options reused across iOS lanes.
def base_deliver_options
  {
    api_key: asc_api_key,
    app_identifier: ENV["BUNDLE_ID"],
    force: true
  }
end

def metadata_deliver_options
  base_deliver_options.merge(
    metadata_path: "#{ROOT_DIR}/fastlane/metadata",
    screenshots_path: "#{ROOT_DIR}/fastlane/screenshots/ios",
    sync_screenshots: true,
    primary_category: ENV.fetch("PRIMARY_CATEGORY", "UTILITIES"),
    secondary_category: ENV.fetch("SECONDARY_CATEGORY", "PRODUCTIVITY")
  )
end

def submission_options
  {
    submit_for_review: ENV.fetch("SUBMIT_FOR_REVIEW", "true") == "true",
    automatic_release: ENV.fetch("AUTOMATIC_RELEASE", "true") == "true"
  }
end

platform :ios do
  lane :deploy_ios do
    deliver(
      metadata_deliver_options.merge(submission_options).merge(
        ipa: Dir.glob("#{APP_DIR}/build/ios/ipa/*.ipa").first,
        app_rating_config_path: "#{ROOT_DIR}/fastlane/app_rating_config.json",
        skip_metadata: !metadata_changed?("fastlane/metadata/ios/"),
        skip_screenshots: !metadata_changed?("fastlane/screenshots/ios/"),
        run_precheck_before_submit: true,
        precheck_include_in_app_purchases: false
      )
    )
  end

  lane :upload_metadata_ios do
    deliver(
      metadata_deliver_options.merge(
        skip_binary_upload: true,
        skip_metadata: false,
        skip_screenshots: false,
        run_precheck_before_submit: false,
        submit_for_review: false
      )
    )
  end

  lane :upload_binary_ios do
    deliver(
      base_deliver_options.merge(submission_options).merge(
        ipa: Dir.glob("#{APP_DIR}/build/ios/ipa/*.ipa").first,
        skip_metadata: true,
        skip_screenshots: true,
        run_precheck_before_submit: true,
        precheck_include_in_app_purchases: false
      )
    )
  end

  lane :sync_iap do
    manage_iap(
      api_key: asc_api_key,
      app_id: ENV["BUNDLE_ID"],
      config_path: "#{ROOT_DIR}/fastlane/iap_config.json"
    )
  end
end
